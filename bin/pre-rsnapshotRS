#!/bin/bash
cd ${HOME}
. /root/bin/getfunction show_time
if [ -z ${2} ]; then
  safe_exit "Missing parameter"
else
	BKType="${1}"
  BKT="$(echo ${BKType}|cut -c 1)"
  FileName="$(date +%F)"
	FN="${2}"
	if [ -z ${FN} ]; then
		printf "Missing \${FN}\n"
		safe_exit "Missing \${FN}"
	fi
	FileExt="${FN}-${BKT}" # LS-D
	TimeStmp="$(date '+%T')"
	TempFile="/tmp/rsnapshot${FileExt}-${TimeStmp}.tmp"
  TempFile=$(echo "${TempFile}"|tr ":" "-")
	PIDFile="rsnapshot${FileExt}"
	PIDFile2="/var/run/rsnapshot${FileExt}.pid"
  LogFile="/var/log/rsnapshot${FileExt}-G.log"
  RSLogFile="/var/log/rsnapshot${FileExt}-RS.log"
	RSConf="/etc/rsnapshot.d/rsnapshot${FileExt}.conf"
  RScmd="rsnapshot -c ${RSConf}"
	SECONDS=0
	# do some work
	( printf "=(D)${FileName}==(T)${TimeStmp}====${FileExt}====${BKType}====Started====\n" >> ${RSLogFile} 2>&1
		printf "=(D)${FileName}==(T)${TimeStmp}====${FileExt}====${BKType}====\n"
		printf "Config File: rsnapshot${FileExt}.conf\n"
		printf "Running: ${RScmd}\n"
		printf "Logfile: ${LogFile}\n"
		printf "RSLogfile: ${RSLogFile}\n"
		printf "Temp File: ${TempFile}\n"
		(	cd /var/run
  		pgid=$(ps -ejf|egrep "${RScmd}"|egrep -v 'grep'|egrep -v 'vim'\
				|awk '{print $4}'|tr -d ' ')
			if [ ! -z ${pgid} ]; then
  			pkill -9 -g ${pgid}
				printf "Killed ${RScmd}\n"
			fi
 			rm -f ${PIDFile2} && printf "Removed $PIDFile2\n" 
			/usr/bin/rsnapshot -c ${RSConf} ${BKType}
		) >> ${RSLogFile} 2>&1 
		pgid=$(ps -ejf|egrep "${RScmd}"|egrep -v 'grep'|egrep -v 'vim'\
			|awk '{print $4}'|tr -d ' ')
		if [ ! -z ${pgid} ]; then
			( pkill -9 -g ${pgid}
				printf "Killed ${RScmd}\n"
			) >> ${RSLogFile} 2>&1 
		fi
		rm -f ${PIDFile2} && printf "Removed $PIDFile2\n" 
		duration=${SECONDS}
		printf "%s Snapshot completed in $(show_time ${duration})\n\n" "${FileExt}" 
		printf "%s Snapshot completed in $(show_time ${duration})\n\n" "${FileExt}" >> ${RSLogFile} 2>&1 
	) >> ${TempFile} 2>&1
	if [ -a ${TempFile} ]; then
		cat ${TempFile} >> ${LogFile}
		rm -f ${TempFile}
	fi
fi
